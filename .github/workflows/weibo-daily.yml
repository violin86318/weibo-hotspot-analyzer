name: å¾®åšçƒ­æœæ¯æ—¥åˆ†æ

on:
  schedule:
    # æ¯å¤© UTC 02:00 æ‰§è¡Œ (åŒ—äº¬æ—¶é—´ 10:00)
    - cron: '0 2 * * *'
    # æ¯å¤© UTC 14:00 æ‰§è¡Œ (åŒ—äº¬æ—¶é—´ 22:00)
    - cron: '0 14 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pages: write
  id-token: write

# å¹¶å‘æ§åˆ¶
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  weibo-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip

      - name: æŠ“å–å¾®åšçƒ­æœ
        env:
          TIANAPI_KEY: ${{ secrets.TIANAPI_KEY }}
        run: |
          python scripts/fetch_weibo_hot.py

      - name: Claude AI åˆ†æåˆ›æ„
        env:
          API_ENDPOINT: ${{ secrets.API_ENDPOINT }}
          API_KEY: ${{ secrets.API_KEY }}
          API_MODEL: ${{ secrets.API_MODEL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python scripts/claude_analysis.py

      - name: ç”Ÿæˆ HTML æŠ¥å‘Š
        run: |
          python scripts/generate_html_report.py

      - name: åˆ›å»ºè¾“å‡ºç›®å½•
        run: |
          mkdir -p reports/$(date +%Y/%m)

      - name: ç§»åŠ¨æŠ¥å‘Šåˆ°è¾“å‡ºç›®å½•
        run: |
          REPORT_FILE=$(ls -t weibo_hotspot_report_*.html 2>/dev/null | head -1)
          if [ -n "$REPORT_FILE" ]; then
            # ä½¿ç”¨æ—¶é—´æˆ³é¿å…è¦†ç›–ï¼š2026-01-18_220000
            TIMESTAMP=$(date +%Y-%m-%d_%H%M%S)
            cp "$REPORT_FILE" "reports/$(date +%Y/%m)/${TIMESTAMP}_weibo_hotspot_report.html"
            echo "âœ… æŠ¥å‘Šå·²å¤åˆ¶åˆ°: reports/$(date +%Y/%m)/${TIMESTAMP}_weibo_hotspot_report.html"

            # åŒæ—¶åˆ›å»ºä¸€ä¸ª latest å‰¯æœ¬ï¼ˆæ–¹ä¾¿è®¿é—®æœ€æ–°æŠ¥å‘Šï¼‰
            cp "$REPORT_FILE" "reports/$(date +%Y/%m)/latest_weibo_hotspot_report.html"
          else
            echo "âŒ æœªæ‰¾åˆ°ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶"
            exit 1
          fi

      - name: æäº¤æŠ¥å‘Š
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add reports/
          git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨ç”Ÿæˆå¾®åšçƒ­æœæŠ¥å‘Š $(date +%Y-%m-%d)"
          git push

      # éƒ¨ç½²åˆ° GitHub Pages
      - name: å‡†å¤‡ Pages éƒ¨ç½²
        run: |
          mkdir -p pages

          # ä¼˜å…ˆä½¿ç”¨ latest å‰¯æœ¬ä½œä¸ºé¦–é¡µï¼ˆå¦‚æœæœ‰ï¼‰
          LATEST_REPORT=$(find reports -name "latest_weibo_hotspot_report.html" -type f | sort -r | head -1)

          # å¦‚æœæ²¡æœ‰ latestï¼Œä½¿ç”¨æœ€æ–°çš„æ—¶é—´æˆ³æŠ¥å‘Š
          if [ -z "$LATEST_REPORT" ]; then
            LATEST_REPORT=$(find reports -name "*_weibo_hotspot_report.html" -type f ! -name "latest_*" | sort -r | head -1)
          fi

          if [ -n "$LATEST_REPORT" ]; then
            cp "$LATEST_REPORT" pages/index.html
            echo "âœ… é¦–é¡µæ›´æ–°ä¸º: $LATEST_REPORT"
          fi

          # å¤åˆ¶æ‰€æœ‰å†å²æŠ¥å‘Š
          cp -r reports/* pages/ 2>/dev/null || true

          # ç”Ÿæˆå†å²æŠ¥å‘Šåˆ—è¡¨é¡µé¢
          echo "ğŸ“‹ ç”Ÿæˆå†å²æŠ¥å‘Šåˆ—è¡¨é¡µé¢..."
          cat > pages/reports.html << 'HTMLEOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å†å²æŠ¥å‘Šåˆ—è¡¨ - å¾®åšçƒ­æœäº§å“åˆ›æ„åˆ†æ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #FF6B35, #FF8C42);
            color: #2D3142;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .header {
            background: white;
            padding: 40px;
            border-radius: 16px;
            margin-bottom: 32px;
            text-align: center;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.3);
        }
        .header h1 {
            font-size: 32px;
            margin-bottom: 16px;
            color: #FF6B35;
        }
        .header p {
            font-size: 16px;
            color: #666;
        }
        .nav-buttons {
            text-align: center;
            margin-top: 20px;
        }
        .nav-buttons a {
            display: inline-block;
            margin: 0 10px;
            padding: 10px 20px;
            background: #FF6B35;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
        }
        .nav-buttons a:hover {
            background: #FF8C42;
        }
        .reports-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }
        .report-card {
            background: white;
            padding: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }
        .report-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }
        .report-card h3 {
            color: #FF6B35;
            margin-bottom: 12px;
            font-size: 18px;
        }
        .report-card .time {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }
        .report-card a {
            display: inline-block;
            margin-top: 12px;
            padding: 8px 16px;
            background: #FF6B35;
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-size: 14px;
        }
        .report-card a:hover {
            background: #FF8C42;
        }
        .footer {
            text-align: center;
            margin-top: 40px;
            color: white;
            padding: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š å¾®åšçƒ­æœå†å²æŠ¥å‘Šåˆ—è¡¨</h1>
            <p>æ‰€æœ‰ç”Ÿæˆçš„äº§å“åˆ›æ„åˆ†ææŠ¥å‘Š - æŒ‰æ—¶é—´å€’åºæ’åˆ—</p>
            <div class="nav-buttons">
                <a href="/">â† è¿”å›é¦–é¡µï¼ˆæœ€æ–°æŠ¥å‘Šï¼‰</a>
            </div>
        </div>
        <div class="reports-grid">
HTMLEOF

          # åˆ—å‡ºæ‰€æœ‰æŠ¥å‘Šï¼ˆæŒ‰æ—¶é—´å€’åºï¼Œæœ€æ–°çš„åœ¨å‰ï¼‰
          find pages -name "*_weibo_hotspot_report.html" -type f ! -name "latest_*" | sort -r | head -50 | while read report; do
            filename=$(basename "$report" .html)
            # æå–æ—¥æœŸå’Œæ—¶é—´
            if [[ $filename =~ ([0-9]{4}-[0-9]{2}-[0-9]{2})_([0-9]{6}) ]]; then
              date="${BASH_REMATCH[1]}"
              time="${BASH_REMATCH[2]}"
              # æ ¼å¼åŒ–æ—¶é—´
              formatted_time="${time:0:2}:${time:2:2}"
            else
              date=$(echo "$filename" | sed 's/_weibo_hotspot_report//')
              time=""
            fi

            cat >> pages/reports.html << HTMLEOF
            <div class="report-card">
                <h3>ğŸ“… $date</h3>
                <p class="time">â° $formatted_time</p>
                <p>å¾®åšçƒ­æœäº§å“åˆ›æ„åˆ†ææŠ¥å‘Š</p>
                <a href="$filename">æŸ¥çœ‹æŠ¥å‘Š â†’</a>
            </div>
HTMLEOF
          done

          cat >> pages/reports.html << 'HTMLEOF
        </div>
        <div class="footer">
            <p>è‡ªåŠ¨ç”Ÿæˆæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S')</p>
            <p>Powered by Claude AI & GitHub Actions</p>
        </div>
    </div>
</body>
</html>
HTMLEOF

          echo "âœ… å†å²æŠ¥å‘Šåˆ—è¡¨é¡µé¢å·²ç”Ÿæˆ"

      - name: ä¸Šä¼ åˆ° GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: weibo-analysis
    
    steps:
      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
