name: å¾®åšçƒ­æœæ¯æ—¥åˆ†æ

on:
  schedule:
    # æ¯å¤© UTC 14:00 æ‰§è¡Œ (åŒ—äº¬æ—¶é—´ 22:00)
    - cron: '0 14 * * *'
  workflow_dispatch: # æ”¯æŒæ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pages: write
  id-token: write

# å¹¶å‘æ§åˆ¶
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  weibo-analysis:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          python -m pip install --upgrade pip

      - name: æŠ“å–å¾®åšçƒ­æœ
        env:
          TIANAPI_KEY: ${{ secrets.TIANAPI_KEY }}
        run: |
          python scripts/fetch_weibo_hot.py

      - name: Claude AI åˆ†æåˆ›æ„
        env:
          API_ENDPOINT: ${{ secrets.API_ENDPOINT }}
          API_KEY: ${{ secrets.API_KEY }}
          API_MODEL: ${{ secrets.API_MODEL }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          python scripts/claude_analysis.py

      - name: ç”Ÿæˆ HTML æŠ¥å‘Š
        run: |
          python scripts/generate_html_report.py

      - name: åˆ›å»ºè¾“å‡ºç›®å½•
        run: |
          mkdir -p reports/$(date +%Y/%m)

      - name: ç§»åŠ¨æŠ¥å‘Šåˆ°è¾“å‡ºç›®å½•
        run: |
          REPORT_FILE=$(ls -t weibo_hotspot_report_*.html 2>/dev/null | head -1)
          if [ -n "$REPORT_FILE" ]; then
            cp "$REPORT_FILE" "reports/$(date +%Y/%m)/$(date +%Y-%m-%d)_weibo_hotspot_report.html"
            echo "âœ… æŠ¥å‘Šå·²å¤åˆ¶åˆ°: reports/$(date +%Y/%m)/$(date +%Y-%m-%d)_weibo_hotspot_report.html"
          else
            echo "âŒ æœªæ‰¾åˆ°ç”Ÿæˆçš„æŠ¥å‘Šæ–‡ä»¶"
            exit 1
          fi

      - name: æäº¤æŠ¥å‘Š
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add reports/
          git diff --staged --quiet || git commit -m "ğŸ¤– è‡ªåŠ¨ç”Ÿæˆå¾®åšçƒ­æœæŠ¥å‘Š $(date +%Y-%m-%d)"
          git push

      # éƒ¨ç½²åˆ° GitHub Pages
      - name: å‡†å¤‡ Pages éƒ¨ç½²
        run: |
          mkdir -p pages
          
          # å¤åˆ¶æœ€æ–°æŠ¥å‘Šåˆ° pages æ ¹ç›®å½•ï¼ˆä½œä¸ºé¦–é¡µï¼‰
          LATEST_REPORT=$(find reports -name "*.html" -type f | sort -r | head -1)
          if [ -n "$LATEST_REPORT" ]; then
            cp "$LATEST_REPORT" pages/index.html
          fi
          
          # å¤åˆ¶æ‰€æœ‰å†å²æŠ¥å‘Š
          cp -r reports/* pages/ 2>/dev/null || true
          
          # ç”ŸæˆæŠ¥å‘Šåˆ—è¡¨é¡µé¢
          python scripts/generate_reports_list.py

      - name: ä¸Šä¼ åˆ° GitHub Pages
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: weibo-analysis
    
    steps:
      - name: éƒ¨ç½²åˆ° GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
